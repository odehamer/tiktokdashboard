<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Live Chat</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="pageTitle">Connecting...</h1>
            <div class="stats-container">
                <div id="viewers">üë• 0</div>
                <div id="totalLikes">‚ù§Ô∏è 0</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="chat-section">
                <div class="chat-container" id="chatContainer"></div>
            </div>
            
            <div class="controls-section">
                <div class="controls-container">
                    <h3>TTS Controls</h3>
                    <div class="button-group">
                        <input type="checkbox" id="toggleTts" checked/>
                        <label for="toggleTts">Toggle TTS</label>
                    </div>
                    
                    <div class="button-group">
                        <input type="checkbox" id="ttsToggleFollow" title="New Follower's next message will be read aloud"/>
                        <label for="ttsToggleFollow" title="New Follower's next message will be read aloud">TTS after follow</label>
                        
                    </div>

                    <div class="button-group" style="flex-direction: column; align-items: flex-start;">
                        <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
                            <input type="checkbox" id="ttsToggleForLikes" title="Chatters will receive tts for each like"/>
                            <label for="ttsToggleForLikes" title="Chatters will receive tts for each like">TTS for likes</label>
                        </div>
                        <div id="likesSliderContainer" style="width: 100%; margin-top: 2px; display: none;">
                            <label for="likesForTts" id="likesValueDisplay">1 like needed for TTS</label>
                            <input type="range" id="likesForTts" min="1" max="15" value="1" step="1" style="width: 100%; margin-top: 6px;"/>
                        </div>
                    </div>

                    <div class="button-group">
                        <input type="checkbox" id="ttsForFollowers"/>
                        <label for="ttsForFollowers">TTS for followers</label>
                    </div>
                    
                    <div class="button-group">
                        <input type="checkbox" id="ttsForEveryone"/>
                        <label for="ttsForEveryone">TTS for everyone</label>
                    </div>

                    <div class="button-group">
                        <input type="checkbox" id="showLikes" checked/>
                        <label for="showLikes">Show Likes</label>
                    </div>
                    
                    <button id="cancelTtsButton" class="action-button">Stop Messages</button>
                </div>
                
                <div class="controls-container">
                    <h3>Voice Settings</h3>
                    <div class="voice-select-group">
                        <label for="voices">Select a Voice:</label>
                        <select id="voices">
                            <option value="">Default</option>
                        </select>
                    </div>

                    <div class="voice-select-group">
                        <label for="ttsVolume">Volume</label>
                        <input type="range" id="ttsVolume" min="0" max="1" value="1" step="0.1">
                    </div>

                    <div class="voice-select-group">
                        <label for="ttsPitch">Pitch</label>
                        <input type="range" id="ttsPitch" min="0.1" max="2" value="1" step="0.1">
                    </div>

                    <div class="voice-select-group">
                        <label for="ttsRate">Speed</label>
                        <input type="range" id="ttsRate" min="0.1" max="2" value="1" step="0.1">
                    </div>

                    <button id="previewVoiceButton" class="action-button" onclick="speak('Hi, I am your selected voice.')">Preview Voice</button>

                </div>
                
                <div class="controls-container">
                    <h3>Statistics</h3>
                    <div class="stat-item">
                        <label>Peak Viewers</label>
                        <div class="stat-value" id="peakViewers">0</div>
                    </div>
                    <div class="stat-item">
                        <label>New Followers</label>
                        <div class="stat-value" id="newFollowers">0</div>
                    </div>
                    <div class="stat-item">
                        <label>üíé Diamonds</label>
                        <div class="stat-value" id="diamondCount">0</div>
                    </div>
                    <div class="stat-item">
                        <label>üí≤ Estimated Earnings</label>
                        <div class="stat-value" id="estimatedEarnings">$0.00</div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>
    
    <script>

        const chatContainer = document.getElementById('chatContainer');
        const viewersDiv = document.getElementById('viewers');
        const totalLikesDiv = document.getElementById('totalLikes');
        const pageTitle = document.getElementById('pageTitle');
        const peakViewersDiv = document.getElementById('peakViewers');
        const diamondCountDiv = document.getElementById('diamondCount');
        const estimatedEarningsDiv = document.getElementById('estimatedEarnings');
        const newFollowersDiv = document.getElementById('newFollowers');
        
        // Connect to WebSocket with username from URL query parameter
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username') || '';
        const ws = new WebSocket(`${protocol}//${window.location.host}?username=${encodeURIComponent(username)}`);

        const ttsQueue = [];
        const followers = [];

        let ttsOn = true;
        let ttsAfterFollow = false;
        let followersHaveTts = false;
        let ttsForLikes = false;
        let everyoneHasTts = false;
        let likesNeededForTts = 1;

        let toggleLikes = true;

        let volume = 1;
        let rate = 1.0;
        let pitch = 1.0;
        let selectedVoice = 'Samantha';
        
        let viewerPeak = 0;
        let diamondCount = 0;
        let newFollowers = 0;

        ws.onopen = () => {
            console.log('Connected to server');
        };
        
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log('Received:', data);
            
            switch(data.type) {
                case 'chat':
                    displayChatMessage(data);
                    break;
                case 'gift':
                    displayGiftMessage(data);
                    break;
                case 'like':
                    displayLikeMessage(data);
                    break;
                case 'follow':
                    displayFollowMessage(data);
                    break;
                case 'viewerCount':
                    displayViewerCount(data.viewerCount);
                    break;
                case 'status':
                    updateStatus(data.message);
                    break;
                case 'error':
                    displayError(data.message);
                    break;
            }
        };
        
        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            displayError('Connection error');
        };
        
        ws.onclose = () => {
            displayError('Disconnected from server');
        };

        function displayViewerCount(count) {
            viewersDiv.textContent = `üë• ${count}`;
            if (count > viewerPeak) {
                viewerPeak = count;
                peakViewersDiv.textContent = viewerPeak;
            }
        }

        function displayTotalLikes(count) {
            totalLikesDiv.textContent = `‚ù§Ô∏è ${count}`;
        }
        
        function displayChatMessage(data) {
            const messageDiv = createMessageElement('message');
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'avatar';
            if (data.avatar) {
                const img = document.createElement('img');
                img.src = data.avatar;
                avatarDiv.appendChild(img);
            } else {
                avatarDiv.textContent = data.user.charAt(0).toUpperCase();
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const usernameSpan = document.createElement('div');
            usernameSpan.className = 'username';
            usernameSpan.textContent = data.name;
            
            const textSpan = document.createElement('div');
            textSpan.className = 'text';
            textSpan.textContent = data.comment;
            
            const timestampSpan = document.createElement('div');
            timestampSpan.className = 'timestamp';
            timestampSpan.textContent = data.timestamp;
            
            contentDiv.appendChild(usernameSpan);
            contentDiv.appendChild(textSpan);
            contentDiv.appendChild(timestampSpan);
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            if (ttsOn) {
                if (everyoneHasTts) {
                    messageDiv.style.backgroundColor = '#fff0f6';
                    speak(data.comment);
                } else if (followersHaveTts && data.isFollower) {
                    messageDiv.style.backgroundColor = '#fff0f6';
                    speak(data.comment);
                } else if (ttsQueue.includes(data.user)) {
                    messageDiv.style.backgroundColor = '#fff0f6';
                    ttsQueue.splice(ttsQueue.indexOf(data.user), 1);
                    speak(data.comment);
                }
            }
        }
        
        function displayGiftMessage(data) {
            const messageDiv = createMessageElement('message gift');
            messageDiv.innerHTML = `<strong>${data.name}</strong> sent ${data.count}x ${data.giftName} üéÅ <span style="font-size: 12px; color: #666;">${data.timestamp}</span>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            diamondCount += data.diamondCount * data.count;
            diamondCountDiv.textContent = diamondCount;
            estimatedEarningsDiv.textContent = `$${(diamondCount * 0.005).toFixed(2)}`;
        }
        
        function displayLikeMessage(data) {
            displayTotalLikes(data.totalLikeCount);
            if (ttsForLikes && data.likeCount >= likesNeededForTts) {
                const likes = new Array(Math.floor(data.likeCount / likesNeededForTts)).fill(data.user);
                ttsQueue.push(...likes);
            }       
            if (!toggleLikes) return;
            console.log(data.type)
            const messageDiv = createMessageElement('message like');
            messageDiv.innerHTML = `<strong>${data.name}</strong> liked! ‚ù§Ô∏è <span style="font-size: 12px; color: #666;">${data.timestamp}</span>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displayFollowMessage(data) {
            const messageDiv = createMessageElement('message status-message');
            messageDiv.innerHTML = `üéâ <strong>${data.name}</strong> just followed! <span style="font-size: 12px; color: #666;">${data.timestamp}</span>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            if (!followers.includes(data.user)) {
                newFollowers += 1;
                newFollowersDiv.textContent = newFollowers;
                if (ttsAfterFollow) {
                    followers.push(data.user);
                    ttsQueue.push(data.user);
                }
            }
        }
        
        function updateStatus(message) {
            if (message.includes('Connected')) {
                pageTitle.textContent = `@${username}'s live chat`;
            }
        }
        
        function displayError(message) {
            const messageDiv = createMessageElement('error');
            messageDiv.textContent = '‚ö†Ô∏è ' + message;
            chatContainer.appendChild(messageDiv);
        }
        
        function createMessageElement(className) {
            const div = document.createElement('div');
            div.className = className;
            return div;
        }

        // Event Listeners
        const toggleTts = document.getElementById('toggleTts');
        toggleTts.addEventListener('change', (e) => {
            ttsOn = e.target.checked;
        });

        // tts after follow toggle
        const ttsToggleFollow = document.getElementById('ttsToggleFollow');
        ttsToggleFollow.addEventListener('change', (e) => {
            ttsAfterFollow = e.target.checked;
        });

        // tts for likes toggle
        const ttsToggleForLikes = document.getElementById('ttsToggleForLikes');
        const likesSliderContainer = document.getElementById('likesSliderContainer');
        ttsToggleForLikes.addEventListener('change', (e) => {
            ttsForLikes = e.target.checked;
            likesSliderContainer.style.display = e.target.checked ? 'block' : 'none';
        });

        const likesForTts = document.getElementById('likesForTts');
        const likesValueDisplay = document.getElementById('likesValueDisplay');
        likesForTts.addEventListener('input', (e) => {
            likesNeededForTts = parseInt(e.target.value, 10);
            if (likesForTts.value === '1') {
                likesValueDisplay.textContent = `${likesNeededForTts} like needed for TTS`;
            } else {
                likesValueDisplay.textContent = `${likesNeededForTts} likes needed for TTS`;
            }
        });

        // tts for followers toggle
        const ttsForFollowers = document.getElementById('ttsForFollowers');
        ttsForFollowers.addEventListener('change', (e) => {
            followersHaveTts = e.target.checked;
        });

        // tts for everyone toggle
        const ttsForEveryone = document.getElementById('ttsForEveryone');
        ttsForEveryone.addEventListener('change', (e) => {
            everyoneHasTts = e.target.checked;
        });

        // show likes toggle
        const showLikes = document.getElementById('showLikes');
        showLikes.addEventListener('change', (e) => {
            toggleLikes = e.target.checked;
        });

        // populate voice list with english voices
        const voicesSelect = document.getElementById('voices');
        function populateVoiceList() {
            console.log('Populating voice list');
            const voices = speechSynthesis.getVoices().filter(voice => voice.lang.slice(0,2) === 'en');
            console.log('Available voices:', voices);
            voices.forEach((voice) => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                voicesSelect.appendChild(option);
            });
        }

        // Populate voices when they load
        speechSynthesis.onvoiceschanged = () => {
            populateVoiceList();
        };

        // Voice selection change
        voices.addEventListener('change', () => {
            selectedVoice = voicesSelect.value;
        });

        // TTS volume control
        const ttsVolume = document.getElementById('ttsVolume');
        ttsVolume.addEventListener('input', () => {
            volume = parseFloat(ttsVolume.value);
        });

        // TTS rate control
        const ttsRate = document.getElementById('ttsRate');
        ttsRate.addEventListener('input', () => {
            rate = parseFloat(ttsRate.value);
        });

        // TTS pitch control
        const ttsPitch = document.getElementById('ttsPitch');
        ttsPitch.addEventListener('input', () => {
            pitch = parseFloat(ttsPitch.value);
        });

        // stop messages button
        const cancelTtsButton = document.getElementById('cancelTtsButton');
        cancelTtsButton.addEventListener('click', () => {
            speechSynthesis.cancel();
        });

        // speak message function
        function speak(text) {
            const msg = new SpeechSynthesisUtterance(text);
            msg.voice = speechSynthesis.getVoices().find(voice => voice.name === selectedVoice);
            msg.rate = rate;
            msg.pitch = pitch;
            msg.volume = volume;
            speechSynthesis.speak(msg);
        }

    </script>
</body>
</html>